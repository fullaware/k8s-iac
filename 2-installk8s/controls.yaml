- hosts: controls
  become: yes
  tasks:
    - name: initialize the cluster
      shell: kubeadm init --pod-network-cidr=10.244.0.0/16
      args:
        chdir: $HOME
        creates: cluster_initialized.txt

    - name: create .kube directory
      become: yes
      become_user: ubuntu
      file:
        path: $HOME/.kube
        state: directory
        mode: 0755

    - name: copies admin.conf to user's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/ubuntu/.kube/config
        remote_src: yes
        owner: ubuntu

    - name: copies kubeconfig locally as kubeconfig.yaml
      fetch:
        src: /home/ubuntu/.kube/config
        dest: ./kubeconfig.yaml
        flat: yes

    - name: install Pod network Antrea
      become: yes
      become_user: ubuntu
      shell: kubectl apply -f https://raw.githubusercontent.com/antrea-io/antrea/main/build/yamls/antrea.yml
      args:
        chdir: $HOME

    - name: install metrics-server
      become: yes
      become_user: ubuntu
      shell: kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
      args:
        chdir: $HOME

    - name: copying patch to server to allow insecure TLS
      become: true 
      copy:
        src: ./patch-metrics-server.yaml
        dest: /home/ubuntu/patch-metrics-server.yaml
        mode: 0777

    - name: patch metrics-server
      become: yes
      become_user: ubuntu
      shell: kubectl -n kube-system patch deploy metrics-server --patch-file patch-metrics-server.yaml
      args:
        chdir: $HOME

    - name: Install OpenEBS operator for storage
      become: yes
      become_user: ubuntu
      shell: kubectl apply -f https://openebs.github.io/charts/openebs-operator-lite.yaml 
      args:
        chdir: $HOME

    - name: Install OpenEBS for HostPath PV storageclass
      become: yes
      become_user: ubuntu
      shell: kubectl apply -f https://openebs.github.io/charts/openebs-lite-sc.yaml
      args:
        chdir: $HOME

    - name: copying patch storageclass openebs-hostpath to be default
      become: true 
      copy:
        src: ./patch-storageclass.yaml
        dest: /home/ubuntu/patch-storageclass.yaml
        mode: 0777

    - name: patch storageclass openebs-hostpath to be default
      become: yes
      become_user: ubuntu
      shell: kubectl patch storageclass openebs-hostpath --patch-file patch-storageclass.yaml
      args:
        chdir: $HOME

    - name: Install Metatllb Load Balancer
      become: yes
      become_user: ubuntu
      shell: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.7/config/manifests/metallb-native.yaml
      args:
        chdir: $HOME

    - name: copying apply-metallb-config.yaml
      become: true 
      copy:
        src: ./apply-metallb-config.yaml
        dest: /home/ubuntu/apply-metallb-config.yaml
        mode: 0777

    - name: apply metallb-config IPAddressPool and L2Advertisement
      become: yes
      become_user: ubuntu
      shell: kubectl apply -f apply-metallb-config.yaml
      args:
        chdir: $HOME

    - name: Install Contour for L7 Ingress
      become: yes
      become_user: ubuntu
      shell: kubectl apply -f https://projectcontour.io/quickstart/contour.yaml
      args:
        chdir: $HOME

    - name: Install Portainer Business Edition (Free for 5 nodes) using LoadBalancer
      become: yes
      become_user: ubuntu
      shell: kubectl apply -n portainer -f https://downloads.portainer.io/ee2-16/portainer-lb.yaml
      args:
        chdir: $HOME


